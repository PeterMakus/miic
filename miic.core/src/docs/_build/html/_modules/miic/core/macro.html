<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>miic.core.macro &mdash; MIIC 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="MIIC 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">MIIC 1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for miic.core.macro</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author:</span>
<span class="sd">Eraldo Pomponi</span>

<span class="sd">@copyright:</span>
<span class="sd">The MIIC Development Team (eraldo.pomponi@uni-leipzig.de)</span>

<span class="sd">@license:</span>
<span class="sd">GNU Lesser General Public License, Version 3</span>
<span class="sd">(http://www.gnu.org/copyleft/lesser.html)</span>

<span class="sd">Created on Dec 15, 2011</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Main imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="kn">as</span> <span class="nn">sio</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.delaunay</span> <span class="kn">as</span> <span class="nn">delaunay</span>

<span class="c"># Configuration storage</span>
<span class="kn">from</span> <span class="nn">configobj</span> <span class="kn">import</span> <span class="n">ConfigObj</span>

<span class="c"># ETS import</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">BC_UI</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">HasTraits</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> \
        <span class="n">Bool</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">File</span>
    <span class="kn">from</span> <span class="nn">traitsui.api</span> <span class="kn">import</span> <span class="n">Item</span><span class="p">,</span> <span class="n">VGroup</span><span class="p">,</span> <span class="n">View</span><span class="p">,</span> <span class="n">Tabbed</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">BC_UI</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">pass</span>

<span class="c"># Local imports</span>
<span class="kn">from</span> <span class="nn">miic.core.ndarray_sigproc</span> <span class="kn">import</span> <span class="n">ndarray_smooth</span><span class="p">,</span> <span class="n">ndarray_filter</span>
<span class="kn">from</span> <span class="nn">miic.core.stretch_mod</span> <span class="kn">import</span> <span class="n">time_windows_creation</span><span class="p">,</span> <span class="n">multi_ref_creation</span><span class="p">,</span> \
    <span class="n">multi_ref_vchange_and_align</span><span class="p">,</span> <span class="n">time_stretch_estimate</span>
<span class="kn">from</span> <span class="nn">miic.core.miic_utils</span> <span class="kn">import</span> <span class="n">dir_read</span><span class="p">,</span> <span class="n">find_comb</span><span class="p">,</span> \
    <span class="n">nd_mat_center_part</span><span class="p">,</span> <span class="n">mat_to_ndarray</span><span class="p">,</span> <span class="n">collapse_to_single_vect</span><span class="p">,</span> \
    <span class="n">convert_time</span><span class="p">,</span> <span class="n">flatten_recarray</span><span class="p">,</span> <span class="n">dv_check</span><span class="p">,</span> <span class="n">lat_lon_ele_load</span><span class="p">,</span> \
    <span class="n">load_pickled_Series_DataFrame_Panel</span><span class="p">,</span> <span class="n">from_single_pattern_to_panel</span>

<span class="kn">from</span> <span class="nn">miic.core.plot_fun</span> <span class="kn">import</span> <span class="n">plot_single_corr_matrix</span><span class="p">,</span> <span class="n">plot_dv</span>

<span class="c">#==============================================================================</span>
<span class="c"># For backward compatibility reasons</span>
<span class="c">#==============================================================================</span>

<span class="kn">from</span> <span class="nn">miic.core.inversion</span> <span class="kn">import</span> \
    <span class="n">inversion_with_missed_data</span> <span class="k">as</span> <span class="n">inversion_with_missed_data_macro</span>

<span class="kn">from</span> <span class="nn">miic.core.miic_utils</span> <span class="kn">import</span> <span class="n">create_date_obj</span>

<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">miic.core.miic_utils</span> <span class="kn">import</span> <span class="n">_from_single_pattern_to_panel_view</span><span class="p">,</span> \
        <span class="n">_create_date_obj_view</span>

<span class="c">###################################################################</span>
<span class="c"># HELP FUNCTIONS</span>
<span class="c">###################################################################</span>


<span class="k">def</span> <span class="nf">_stack</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">vect</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Stacks together arrays of compatible size.</span>

<span class="sd">    This function stacks (pile up) array with compatible size to create a</span>
<span class="sd">    matrix. This stack can be done row-wise (``axis=0``) or column-wise</span>
<span class="sd">    (``axis=1``). To achieve this behaviour in a function based environment</span>
<span class="sd">    like blockcanvas, it uses a ``global`` variable that persist between</span>
<span class="sd">    successive call to this routine.</span>
<span class="sd">    It must be taken into account that this global variable needs to be</span>
<span class="sd">    reseted by hand if it is necessary to restart the piling procedure</span>
<span class="sd">    (see also the function ``clear_global_X``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vect : ndarray</span>
<span class="sd">        1D Array to stack with the current global variable ``X``</span>
<span class="sd">    axis : int</span>
<span class="sd">        Stacking axis. 0: row-wise</span>
<span class="sd">                       1: column-wise</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Global variable that holds the stacked data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vect</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="p">(</span><span class="n">vect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">X</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">vect</span><span class="o">.</span><span class="n">size</span><span class="p">))])</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">vect</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">vect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))])</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Exception occurred stacking data!!!&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>

            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">fv</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">fv</span><span class="p">])</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">X</span>

<span class="c">###################################################################</span>
<span class="c"># SPECIAL CALLABLE CLASS                                          #</span>
<span class="c">###################################################################</span>


<span class="k">class</span> <span class="nc">_RecombineCorrData</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">channels_pair</span><span class="p">,</span> \
                 <span class="n">center_win_len</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">base_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
        <span class="c"># self.time_dir = time_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels_pair</span> <span class="o">=</span> <span class="n">channels_pair</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span> <span class="o">=</span> <span class="n">center_win_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>

        <span class="k">print</span> <span class="s">&quot;#### Start sequence for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

        <span class="n">f_pattern</span> <span class="o">=</span> \
            <span class="s">&#39;*&#39;</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">+</span> \
            <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="c"># To handle old style filenames we need to add the _.mat later</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">cf_pattern</span> <span class="o">=</span> <span class="n">f_pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>

            <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
                       <span class="n">pattern</span><span class="o">=</span><span class="n">cf_pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span><span class="p">,</span>
                       <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
                                   <span class="n">pattern</span><span class="o">=</span><span class="n">f_pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span><span class="p">,</span>
                                   <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">files_list1</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="c"># Try the old style names with channel pairs in the end</span>
            <span class="n">f_pattern</span> <span class="o">=</span> <span class="n">f_pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_pair</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">cf_pattern</span> <span class="o">=</span> <span class="n">f_pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>

                <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
                           <span class="n">pattern</span><span class="o">=</span><span class="n">cf_pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span><span class="p">,</span>
                           <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
                                       <span class="n">pattern</span><span class="o">=</span><span class="n">f_pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span><span class="p">,</span>
                                       <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">default_var_name</span> <span class="o">=</span> <span class="s">&#39;corr_trace&#39;</span>
        <span class="n">time_format</span> <span class="o">=</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">Z&quot;</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">stats_tr1</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">stats_tr2</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">first_stats_tr1</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">first_stats_tr2</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">time_vect</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">celem1</span> <span class="ow">in</span> <span class="n">files_list1</span><span class="p">:</span>

                <span class="n">load_var1</span> <span class="o">=</span> <span class="n">mat_to_ndarray</span><span class="p">(</span><span class="n">celem1</span><span class="p">)</span>

                <span class="c"># Get stats the first time it is available</span>
                <span class="k">if</span> <span class="n">stats</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats&#39;</span><span class="p">])</span>
                <span class="c"># Take the first stats_tr1 and stats_tr2 obj as a sample</span>
                <span class="c"># of the specific meta-information of the combined traces</span>
                <span class="k">if</span> <span class="n">stats_tr1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;stats_tr1&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                        <span class="n">first_stats_tr1</span> <span class="o">=</span> \
                            <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats_tr1&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">stats_tr2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;stats_tr2&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                        <span class="n">first_stats_tr2</span> <span class="o">=</span> \
                            <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats_tr2&#39;</span><span class="p">])</span>

                <span class="c"># Take the timing from the stats_tr1 and stats_tr2 obj when</span>
                <span class="c"># available</span>
                <span class="k">if</span> <span class="s">&#39;stats_tr1&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span> <span class="ow">and</span> <span class="s">&#39;stats_tr2&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                    <span class="n">stats_tr1</span> <span class="o">=</span> <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats_tr1&#39;</span><span class="p">])</span>
                    <span class="n">stats_tr2</span> <span class="o">=</span> <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats_tr2&#39;</span><span class="p">])</span>

                    <span class="n">time_tr1</span> <span class="o">=</span> \
                        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">stats_tr1</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span>
                                                          <span class="n">time_format</span><span class="p">)</span>

                    <span class="n">time_tr2</span> <span class="o">=</span> \
                        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">stats_tr2</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span>
                                                          <span class="n">time_format</span><span class="p">)</span>

                    <span class="n">mtime</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">time_tr1</span><span class="p">,</span> <span class="n">time_tr2</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mtime</span> <span class="o">=</span> \
                        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>\
                                        <span class="n">flatten_recarray</span><span class="p">(</span><span class="n">stats</span><span class="p">)[</span><span class="s">&#39;starttime&#39;</span><span class="p">],</span>
                                        <span class="n">time_format</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;Warning: stats_tr1 or stats_tr2 not available: use </span><span class="se">\</span>
<span class="s">                        default time </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mtime</span>

                <span class="n">time_vect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span>

                <span class="n">tr_pattern</span> <span class="o">=</span> <span class="s">&#39;trace_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>  <span class="c"># + &#39;_&#39; + self.channels_pair</span>
                <span class="k">if</span> <span class="n">tr_pattern</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                    <span class="n">result1</span> <span class="o">=</span> <span class="n">load_var1</span><span class="p">[</span><span class="n">tr_pattern</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">default_var_name</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                    <span class="n">result1</span> <span class="o">=</span> <span class="n">load_var1</span><span class="p">[</span><span class="n">default_var_name</span><span class="p">]</span>

                <span class="n">X</span> <span class="o">=</span> <span class="n">_stack</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">result1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: EXIT for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="s">&#39;npts&#39;</span><span class="p">]):</span>

                <span class="n">cent_mat1</span> <span class="o">=</span> <span class="n">nd_mat_center_part</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c"># adjust starttime endtime and npts in stats</span>

                <span class="c"># Trace length in seconds</span>

<span class="c">#                trace_length = self.center_win_len / stats[&#39;sampling_rate&#39;]</span>
<span class="c">#                trace_length_delta = datetime.timedelta(seconds=trace_length)</span>
<span class="c">#                zerotime = datetime.datetime(1971, 1, 1, 0, 0, 0)</span>
<span class="c">#</span>
<span class="c">#                new_starttime = zerotime - (trace_length_delta / 2)</span>
<span class="c">#                new_endtime = new_starttime + trace_length_delta</span>
<span class="c">#</span>
<span class="c">#                stats[&#39;starttime&#39;] = new_starttime.isoformat()</span>
<span class="c">#                stats[&#39;endtime&#39;] = new_endtime.isoformat()</span>
<span class="c">#                stats[&#39;npts&#39;] = self.center_win_len</span>

                <span class="c"># adjust starttime endtime and npts in stats</span>
                <span class="c"># trace_length = int(self.center_win_len * \</span>
                <span class="c"># stats[&#39;sampling_rate&#39;])</span>
                <span class="c"># time from old to new start</span>
                <span class="n">timeOffset</span> <span class="o">=</span> \
                    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;npts&#39;</span><span class="p">]</span> <span class="o">-</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
                                       <span class="n">stats</span><span class="p">[</span><span class="s">&#39;sampling_rate&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">timeOffset</span>
                                  <span class="o">+</span> <span class="n">convert_time</span><span class="p">([</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="n">time_format</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s">&#39;npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span>
                <span class="n">stats</span><span class="p">[</span><span class="s">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>\
                        <span class="n">convert_time</span><span class="p">([</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;starttime&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
                        <span class="n">stats</span><span class="p">[</span><span class="s">&#39;sampling_rate&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">86400</span><span class="p">),</span> <span class="n">time_format</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">first_stats_tr1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="n">first_stats_tr2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                    <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                                <span class="p">{</span><span class="s">&#39;corr_data&#39;</span><span class="p">:</span> <span class="n">cent_mat1</span><span class="p">,</span>
                                 <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">time_vect</span><span class="p">,</span>
                                 <span class="s">&#39;stats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
                                 <span class="s">&#39;stats_tr1&#39;</span><span class="p">:</span> <span class="n">first_stats_tr1</span><span class="p">,</span>
                                 <span class="s">&#39;stats_tr2&#39;</span><span class="p">:</span> <span class="n">first_stats_tr2</span><span class="p">},</span>
                                <span class="n">oned_as</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                                <span class="p">{</span><span class="s">&#39;corr_data&#39;</span><span class="p">:</span> <span class="n">cent_mat1</span><span class="p">,</span>
                                 <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">time_vect</span><span class="p">,</span>
                                 <span class="s">&#39;stats&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">},</span>
                                <span class="n">oned_as</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: No matrix created </span><span class="se">\</span>
<span class="s">                    for pattern </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
                <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

            <span class="k">print</span> <span class="s">&quot;#### SUCCESSFULLY END sequence for </span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

            <span class="k">return</span> <span class="s">&#39;SUCCESS_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Saving result</span><span class="se">\</span>
<span class="s">                for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>


<span class="c">###################################################################</span>
<span class="c"># MAIN</span>
<span class="c">###################################################################</span>

<div class="viewcode-block" id="recombine_corr_data"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.recombine_corr_data.html#miic.core.macro.recombine_corr_data">[docs]</a><span class="k">def</span> <span class="nf">recombine_corr_data</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> \
                        <span class="n">center_win_len</span><span class="p">,</span> \
                        <span class="n">channels_pair</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">old_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Correlation matrix creation.</span>

<span class="sd">    This function creates the whole set of correlation matrix starting from</span>
<span class="sd">    a set of corr functions (one for each day and for each stations pair</span>
<span class="sd">     - cross - or station - auto - ). The mat files that are created contains</span>
<span class="sd">    two variables: ``corr_data`` that stores the correlation matrix and</span>
<span class="sd">    ``time`` that stores timing informations</span>

<span class="sd">    :type base_name: string</span>
<span class="sd">    :param base_name: Common &quot;root&quot; for every generated filename. It must not</span>
<span class="sd">        include underscores</span>
<span class="sd">    :param suffix: Optional suffix for the filename (it must be the same used</span>
<span class="sd">        with the :class:`~miic.core.miic_utils.convert_to_matlab` function</span>
<span class="sd">        through with the data were saved)</span>
<span class="sd">    :type base_dir: string</span>
<span class="sd">    :param base_dir: Where the corr functions are stored</span>
<span class="sd">    :type save_dir: string</span>
<span class="sd">    :param save_dir: Where all the corr matrix will be saved</span>
<span class="sd">    :type channels_pair: string</span>
<span class="sd">    :param channels_pair: The channels pair that we are interested with</span>
<span class="sd">        (e.g. &#39;HHZ-HHZ&#39;)</span>
<span class="sd">    :type patters_list_filename: string</span>
<span class="sd">    :param patters_list_filename: File where the results obtained with this</span>
<span class="sd">        procedure will be logged. It is necessary for the DataFrame</span>
<span class="sd">        construction in the function `from_single_pattern_to_dataframe`</span>
<span class="sd">    :type fs: float</span>
<span class="sd">    :param fs: Pseudo Sampling frequency for the corr curve</span>
<span class="sd">    :type old_style: bool</span>
<span class="sd">    :param old_style: If true, the suffic is generated using the `fs`</span>
<span class="sd">        ( &quot;_&lt;fs&gt;Hz&quot;) instead of being passed as a parameter)</span>
<span class="sd">    :type parallel: bool</span>
<span class="sd">    :param parallel: if true it tries to use as much cores as are available to</span>
<span class="sd">        do the computation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;`save_dir` doesn&#39;t exist ..... creating&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">old_style</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">Hz&quot;</span> <span class="o">%</span> <span class="n">fs</span>

    <span class="n">base_patterns</span> <span class="o">=</span> <span class="n">find_comb</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="c"># Create a pool of process</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_RecombineCorrData</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> \
                                                  <span class="n">base_dir</span><span class="p">,</span> \
                                                  <span class="n">save_dir</span><span class="p">,</span> \
                                                  <span class="n">channels_pair</span><span class="p">,</span> \
                                                  <span class="n">center_win_len</span><span class="p">,</span> \
                                                  <span class="n">suffix</span><span class="p">),</span> \
                               <span class="n">base_patterns</span><span class="p">)</span>

        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_RecombineCorrData</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> \
                                             <span class="n">base_dir</span><span class="p">,</span> \
                                             <span class="n">save_dir</span><span class="p">,</span> \
                                             <span class="n">channels_pair</span><span class="p">,</span> \
                                             <span class="n">center_win_len</span><span class="p">,</span> \
                                             <span class="n">suffix</span><span class="p">),</span> \
                          <span class="n">base_patterns</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;success_patterns.npy&#39;</span><span class="p">),</span> \
            <span class="n">successfull</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_recombine_corr_data_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;trace&#39;</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">channels_pair</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;Z-Z&#39;</span><span class="p">)</span>
        <span class="n">center_win_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">3000</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">old_style</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_name&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;suffix&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_dir&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;center_win_len&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;old_style&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;parallel&#39;</span><span class="p">),</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s">&#39;Config&#39;</span>
                                 <span class="p">),</span>
                          <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;channels_pair&#39;</span><span class="p">,</span>
                                      <span class="n">label</span><span class="o">=</span><span class="s">&#39;Channel pair [e.g.HHZ-HHZ]&#39;</span><span class="p">),</span>
                                 <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">),</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s">&#39;Old setup extras&#39;</span><span class="p">,</span>
                                 <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;old_style&#39;</span><span class="p">))</span>

<span class="c">###################################################################</span>
<span class="c"># SPECIAL CALLABLE CLASS                                          #</span>
<span class="c">###################################################################</span>


<span class="k">class</span> <span class="nc">_VChangeEstimate</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">center_win_len</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> \
                 <span class="n">fs</span><span class="p">,</span> <span class="n">smooth_win</span><span class="p">,</span> <span class="n">tw_start_list</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">,</span> <span class="n">st_range</span><span class="p">,</span> <span class="n">st_steps</span><span class="p">,</span> \
                 <span class="n">suffix</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span> <span class="o">=</span> <span class="n">center_win_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span> <span class="o">=</span> <span class="n">fmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_win</span> <span class="o">=</span> <span class="n">smooth_win</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw_start_list</span> <span class="o">=</span> <span class="n">tw_start_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw_len</span> <span class="o">=</span> <span class="n">tw_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st_range</span> <span class="o">=</span> <span class="n">st_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st_steps</span> <span class="o">=</span> <span class="n">st_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>

        <span class="k">print</span> <span class="s">&quot;#### Start sequence for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">f_pattern</span><span class="p">)</span>
            <span class="n">load_var1</span> <span class="o">=</span> <span class="n">mat_to_ndarray</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;corr_data&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Loading mat for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cent_mat1</span> <span class="o">=</span> <span class="n">nd_mat_center_part</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">X3</span> <span class="o">=</span> <span class="n">ndarray_filter</span><span class="p">(</span><span class="n">cent_mat1</span><span class="p">,</span> <span class="s">&#39;bandpass&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> \
                                <span class="p">{</span><span class="s">&#39;corners&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="s">&#39;zerophase&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> \
                                 <span class="s">&#39;freqmax&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">,</span> <span class="s">&#39;freqmin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span><span class="p">})</span>
            <span class="n">X5</span> <span class="o">=</span> <span class="n">ndarray_smooth</span><span class="p">(</span><span class="n">X3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_win</span><span class="p">,</span> <span class="s">&#39;flat&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Filtering for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">rowd1</span> <span class="o">=</span> <span class="n">collapse_to_single_vect</span><span class="p">(</span><span class="n">X5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tw_mat2</span> <span class="o">=</span> <span class="n">time_windows_creation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tw_start_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw_len</span><span class="p">)</span>

            <span class="n">vdict</span> <span class="o">=</span> <span class="n">time_stretch_estimate</span><span class="p">(</span><span class="n">X5</span><span class="p">,</span> <span class="n">ref_trc</span><span class="o">=</span><span class="n">rowd1</span><span class="p">,</span>
                                          <span class="n">tw</span><span class="o">=</span><span class="n">tw_mat2</span><span class="p">,</span>
                                          <span class="n">stretch_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">st_range</span><span class="p">,</span>
                                          <span class="n">stretch_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">st_steps</span><span class="p">,</span>
                                          <span class="n">sides</span><span class="o">=</span><span class="s">&#39;both&#39;</span><span class="p">)</span>

<span class="c">#            new_m1, deltas1 = stretch_mat_creation(rowd1, \</span>
<span class="c">#                                                   str_range=self.st_range, \</span>
<span class="c">#                                                   nstr=self.st_steps)</span>
<span class="c">#            vdict = velocity_change_estimete(X5, tw_mat2,</span>
<span class="c">#                                             new_m1, deltas1,</span>
<span class="c">#                                             return_sim_mat=True)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Velocity change estimate</span><span class="se">\</span>
<span class="s">                for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">vchange_file_name</span> <span class="o">=</span> <span class="s">&#39;vchange_full_&#39;</span> <span class="o">+</span> \
                    <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vchange_file_name</span> <span class="o">=</span> <span class="s">&#39;vchange_full_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>

            <span class="n">vdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]})</span>

            <span class="k">if</span> <span class="s">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                <span class="n">vdict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;stats&#39;</span><span class="p">:</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats&#39;</span><span class="p">]})</span>

            <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">vchange_file_name</span><span class="p">),</span> \
                        <span class="n">vdict</span><span class="p">,</span>
                        <span class="n">oned_as</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">)</span>

            <span class="k">print</span> <span class="s">&quot;#### SUCCESSFULLY END sequence for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

            <span class="k">return</span> <span class="s">&#39;SUCCESS_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Saving result for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>


<div class="viewcode-block" id="vchange_estimate"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.vchange_estimate.html#miic.core.macro.vchange_estimate">[docs]</a><span class="k">def</span> <span class="nf">vchange_estimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                     <span class="n">suffix</span><span class="p">,</span> \
                     <span class="n">save_dir</span><span class="p">,</span> \
                     <span class="c"># corr_dir, \</span>
                     <span class="n">center_win_len</span><span class="p">,</span> \
                     <span class="n">fmax</span><span class="p">,</span> \
                     <span class="n">fmin</span><span class="p">,</span> \
                     <span class="n">order</span><span class="p">,</span> \
                     <span class="n">fs</span><span class="p">,</span> \
                     <span class="n">smooth_win</span><span class="p">,</span> \
                     <span class="n">tw_start_list</span><span class="p">,</span> \
                     <span class="n">tw_len</span><span class="p">,</span> \
                     <span class="n">st_range</span><span class="p">,</span> \
                     <span class="n">st_steps</span><span class="p">,</span> \
                     <span class="n">list_of_combinations</span><span class="p">,</span> \
                     <span class="nb">all</span><span class="p">,</span> <span class="n">old_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Velocity change estimation macro.</span>

<span class="sd">    This function, starting from the whole set of correlation matrix created</span>
<span class="sd">    for a defined dataset, evaluate the velocity change doing a simple</span>
<span class="sd">    pre-processing:</span>
<span class="sd">       bandpass filtering and smoothing.</span>

<span class="sd">    :type base_dir: string</span>
<span class="sd">    :param base_dir: Where the corr matrix are stored</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    :param suffix: Optional suffix for the filename (it must be the same used</span>
<span class="sd">        with the :class:`~miic.core.macro.recombine_corr_data` function</span>
<span class="sd">        through with the corr matrix were saved)</span>
<span class="sd">    :type save_dir: string</span>
<span class="sd">    :param save_dir: Where all the velocity change traces and the corresponding</span>
<span class="sd">        corr traces will be saved.</span>
<span class="sd">    :type center_win_len: int</span>
<span class="sd">    :param center_win_len: How many samples will be taken from the central part</span>
<span class="sd">        of the corr func</span>
<span class="sd">    :type fmax: float</span>
<span class="sd">    :param fmax: Maximum freq for the bandpass filter</span>
<span class="sd">    :type fmin: float</span>
<span class="sd">    :param fmin: Minimum freq for the bandpass filter</span>
<span class="sd">    :type order: int</span>
<span class="sd">    :param order: Filter order (i.e. corners in obspy terminology)</span>
<span class="sd">    :type fs: float</span>
<span class="sd">    :param fs: Sampling frequency for the corr trace</span>
<span class="sd">    :type smooth_win: int</span>
<span class="sd">    :param smooth_win: Width of the smoothing window</span>
<span class="sd">    :type tw_start_list: list of int</span>
<span class="sd">    :param tw_start_list: List of time lag (in samples) that we want to adopt</span>
<span class="sd">        in the velocity change evaluation</span>
<span class="sd">    :type tw_len: int</span>
<span class="sd">    :param tw_len: Time window length in samples for each time lag</span>
<span class="sd">    :type st_range: float</span>
<span class="sd">    :param st_range: Stretching range (i.e. 0.01 -&gt; 1%)</span>
<span class="sd">    :type st_steps: int</span>
<span class="sd">    :param st_steps: How many stretching steps in the specified range</span>
<span class="sd">    :type list_of_combinations: string</span>
<span class="sd">    :param list_of_combinations: The list of combinations that we want to plot</span>
<span class="sd">        (e.g. [&#39;QC01-QC02&#39;,&#39;QC05-QC11&#39;]</span>
<span class="sd">    :type all: bool</span>
<span class="sd">    :param all: If true all possible combinations will be calculated</span>
<span class="sd">    :type old_style: bool</span>
<span class="sd">    :param old_style: If true, the suffix is generated using the `fs`</span>
<span class="sd">        ( &quot;_&lt;fs&gt;Hz&quot;) instead of being passed as a parameter)</span>
<span class="sd">    :type parallel: bool</span>
<span class="sd">    :param parallel: if true it tries to use as much cores as are available to</span>
<span class="sd">        do the computation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;`save_dir` doesn&#39;t exist ..... creating&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">old_style</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">Hz&quot;</span> <span class="o">%</span> <span class="n">fs</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
        <span class="c"># base_patterns = find_comb(corr_dir, suffix=suffix)</span>
        <span class="n">base_patterns</span> <span class="o">=</span> <span class="n">find_comb</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">is_mat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_patterns</span> <span class="o">=</span> <span class="n">list_of_combinations</span>

    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_VChangeEstimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                                                <span class="n">save_dir</span><span class="p">,</span> \
                                                <span class="n">center_win_len</span><span class="p">,</span> \
                                                <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> \
                                                <span class="n">smooth_win</span><span class="p">,</span> \
                                                <span class="n">tw_start_list</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">,</span> \
                                                <span class="n">st_range</span><span class="p">,</span> <span class="n">st_steps</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span> \
                               <span class="n">base_patterns</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_VChangeEstimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                                           <span class="n">save_dir</span><span class="p">,</span> \
                                           <span class="n">center_win_len</span><span class="p">,</span> \
                                           <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> \
                                           <span class="n">smooth_win</span><span class="p">,</span> \
                                           <span class="n">tw_start_list</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">,</span> \
                                           <span class="n">st_range</span><span class="p">,</span> <span class="n">st_steps</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span> \
                          <span class="n">base_patterns</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;success_patterns.npy&#39;</span><span class="p">),</span> \
            <span class="n">successfull</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_vchange_estimate_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="c"># corr_dir = Directory()</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">smooth_win</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">center_win_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">tw_start_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>
        <span class="n">tw_len</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="n">st_range</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">st_steps</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">list_of_combinations</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">)</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">old_style</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Tabbed</span><span class="p">(</span><span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_dir&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                                        <span class="c"># Item(&#39;corr_dir&#39;),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;old_style&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;suffix&#39;</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="s">&#39;filename suffix&#39;</span><span class="p">,</span>
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;not old_style&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;parallel&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Directories&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmax&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmin&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;smooth_win&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Processing&#39;</span><span class="p">),</span>
                                 <span class="n">Tabbed</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_start_list&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_len&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;center_win_len&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Time lag&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_range&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_steps&#39;</span><span class="p">),</span>
                                        <span class="c"># Item(&#39;patters_list_filename&#39;, \</span>
                                        <span class="c">#     label=&#39;patters_list_filename\</span>
                                        <span class="c">#     (no ext)&#39;),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Stretch&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;list_of_combinations&#39;</span><span class="p">,</span> \
                                             <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;all==False&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;combinations&#39;</span><span class="p">)))</span>
    
<span class="c">##############################################################################</span>
<span class="c"># MULTI-REFERENCE VELOCITY CHANGE ESTIMATE                                   #</span>
<span class="c">##############################################################################</span>


<span class="k">class</span> <span class="nc">_VChangeEstimateMultiRef</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">center_win_len</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> \
                 <span class="n">fs</span><span class="p">,</span> <span class="n">smooth_win</span><span class="p">,</span> <span class="n">tw_start</span><span class="p">,</span> <span class="n">tw_len</span><span class="p">,</span> <span class="n">st_range</span><span class="p">,</span> <span class="n">st_steps</span><span class="p">,</span> \
                 <span class="n">suffix</span><span class="p">,</span> <span class="n">multi_ref_freq</span><span class="p">,</span> <span class="n">use_breakpoint</span><span class="p">,</span> <span class="n">breakpoint</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span> <span class="o">=</span> <span class="n">center_win_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span> <span class="o">=</span> <span class="n">fmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_win</span> <span class="o">=</span> <span class="n">smooth_win</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw_start</span> <span class="o">=</span> <span class="n">tw_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tw_len</span> <span class="o">=</span> <span class="n">tw_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st_range</span> <span class="o">=</span> <span class="n">st_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st_steps</span> <span class="o">=</span> <span class="n">st_steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi_ref_freq</span> <span class="o">=</span> <span class="n">multi_ref_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_breakpoint</span> <span class="o">=</span> <span class="n">use_breakpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakpoint</span> <span class="o">=</span> <span class="n">breakpoint</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>

        <span class="k">print</span> <span class="s">&quot;#### Start sequence for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;mat_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">f_pattern</span><span class="p">)</span>
            <span class="n">load_var1</span> <span class="o">=</span> <span class="n">mat_to_ndarray</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;corr_data&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Loading mat for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cent_mat1</span> <span class="o">=</span> <span class="n">nd_mat_center_part</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_win_len</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">X3</span> <span class="o">=</span> <span class="n">ndarray_filter</span><span class="p">(</span><span class="n">cent_mat1</span><span class="p">,</span> <span class="s">&#39;bandpass&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> \
                                <span class="p">{</span><span class="s">&#39;corners&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="s">&#39;zerophase&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> \
                                 <span class="s">&#39;freqmax&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmax</span><span class="p">,</span> <span class="s">&#39;freqmin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmin</span><span class="p">})</span>
            <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">ndarray_smooth</span><span class="p">(</span><span class="n">X3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_win</span><span class="p">,</span> <span class="s">&#39;flat&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Filtering for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">rtime</span> <span class="o">=</span> <span class="n">convert_time</span><span class="p">(</span><span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">])</span>
            <span class="n">ref_mat</span> <span class="o">=</span> <span class="n">multi_ref_creation</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span>
                                         <span class="n">rtime</span><span class="p">,</span>
                                         <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multi_ref_freq</span><span class="p">,</span>
                                         <span class="n">use_break_point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_breakpoint</span><span class="p">,</span>
                                         <span class="n">break_point</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">breakpoint</span><span class="p">)</span>

            <span class="n">tw</span> <span class="o">=</span> <span class="n">time_windows_creation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tw_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tw_len</span><span class="p">)</span>

            <span class="n">dv</span> <span class="o">=</span> <span class="n">multi_ref_vchange_and_align</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span>
                                             <span class="n">ref_mat</span><span class="p">,</span>
                                             <span class="n">tw</span><span class="o">=</span><span class="n">tw</span><span class="p">,</span>
                                             <span class="n">stretch_range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">st_range</span><span class="p">,</span>
                                             <span class="n">stretch_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">st_steps</span><span class="p">,</span>
                                             <span class="n">return_sim_mat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Velocity change estimate</span><span class="se">\</span>
<span class="s">                for pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="n">vchange_file_name</span> <span class="o">=</span> <span class="s">&#39;vchange_full_&#39;</span> <span class="o">+</span> \
                    <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vchange_file_name</span> <span class="o">=</span> <span class="s">&#39;vchange_full_&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s">&#39;.mat&#39;</span>

            <span class="c"># ADD meta-information to the returned dictionary</span>

            <span class="k">if</span> <span class="s">&#39;stats&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                <span class="n">dv</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;stats&#39;</span><span class="p">:</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;stats&#39;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="s">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">load_var1</span><span class="p">:</span>
                <span class="n">dv</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="n">load_var1</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">]})</span>

            <span class="n">sio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">vchange_file_name</span><span class="p">),</span>
                        <span class="n">dv</span><span class="p">,</span>
                        <span class="n">oned_as</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">)</span>

            <span class="k">print</span> <span class="s">&quot;#### SUCCESSFULLY END sequence for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pattern</span>

            <span class="k">return</span> <span class="s">&#39;SUCCESS_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;#### Sequence ERROR: Saving result for</span><span class="se">\</span>
<span class="s">                pattern </span><span class="si">%s</span><span class="s"> ####&quot;</span> <span class="o">%</span> <span class="n">pattern</span>
            <span class="k">print</span> <span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="k">print</span> <span class="s">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">30</span>
            <span class="k">return</span> <span class="s">&#39;FAILED_&#39;</span> <span class="o">+</span> <span class="n">pattern</span>


<div class="viewcode-block" id="vchange_estimate_multi_ref"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.vchange_estimate_multi_ref.html#miic.core.macro.vchange_estimate_multi_ref">[docs]</a><span class="k">def</span> <span class="nf">vchange_estimate_multi_ref</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                               <span class="n">suffix</span><span class="p">,</span> \
                               <span class="n">save_dir</span><span class="p">,</span> \
                               <span class="c"># corr_dir, \</span>
                               <span class="n">center_win_len</span><span class="p">,</span> \
                               <span class="n">fmax</span><span class="p">,</span> \
                               <span class="n">fmin</span><span class="p">,</span> \
                               <span class="n">order</span><span class="p">,</span> \
                               <span class="n">fs</span><span class="p">,</span> \
                               <span class="n">smooth_win</span><span class="p">,</span> \
                               <span class="n">tw_start</span><span class="p">,</span> \
                               <span class="n">tw_len</span><span class="p">,</span> \
                               <span class="n">st_range</span><span class="p">,</span> \
                               <span class="n">st_steps</span><span class="p">,</span> \
                               <span class="n">list_of_combinations</span><span class="p">,</span> \
                               <span class="nb">all</span><span class="p">,</span> \
                               <span class="n">multi_ref_freq</span><span class="p">,</span> \
                               <span class="n">use_breakpoint</span><span class="p">,</span> \
                               <span class="n">breakpoint</span><span class="p">,</span> \
                               <span class="n">old_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                               <span class="n">parallel</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Velocity change estimation macro.</span>

<span class="sd">    This function, starting from the whole set of correlation matrix created</span>
<span class="sd">    for a defined dataset, evaluate the velocity change doing a simple</span>
<span class="sd">    pre-processing:</span>
<span class="sd">       bandpass filtering and smoothing.</span>

<span class="sd">    :type base_dir: string</span>
<span class="sd">    :param base_dir: Where the corr matrix are stored</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    :param suffix: Optional suffix for the filename (it must be the same used</span>
<span class="sd">        with the :class:`~miic.core.macro.recombine_corr_data` function</span>
<span class="sd">        through with the corr matrix were saved)</span>
<span class="sd">    :type save_dir: string</span>
<span class="sd">    :param save_dir: Where all the velocity change traces and the corresponding</span>
<span class="sd">        corr traces will be saved.</span>
<span class="sd">    :type center_win_len: int</span>
<span class="sd">    :param center_win_len: How many samples will be taken from the central part</span>
<span class="sd">        of the corr func</span>
<span class="sd">    :type fmax: float</span>
<span class="sd">    :param fmax: Maximum freq for the bandpass filter</span>
<span class="sd">    :type fmin: float</span>
<span class="sd">    :param fmin: Minimum freq for the bandpass filter</span>
<span class="sd">    :type order: int</span>
<span class="sd">    :param order: Filter order (i.e. corners in obspy terminology)</span>
<span class="sd">    :type fs: float</span>
<span class="sd">    :param fs: Sampling frequency for the corr trace</span>
<span class="sd">    :type smooth_win: int</span>
<span class="sd">    :param smooth_win: Width of the smoothing window</span>
<span class="sd">    :type tw_start_list: list of int</span>
<span class="sd">    :param tw_start_list: List of time lag (in samples) that we want to adopt</span>
<span class="sd">        in the velocity change evaluation</span>
<span class="sd">    :type tw_len: int</span>
<span class="sd">    :param tw_len: Time window length in samples for each time lag</span>
<span class="sd">    :type st_range: float</span>
<span class="sd">    :param st_range: Stretching range (i.e. 0.01 -&gt; 1%)</span>
<span class="sd">    :type st_steps: int</span>
<span class="sd">    :param st_steps: How many stretching steps in the specified range</span>
<span class="sd">    :type list_of_combinations: string</span>
<span class="sd">    :param list_of_combinations: The list of combinations that we want to plot</span>
<span class="sd">        (e.g. [&#39;QC01-QC02&#39;,&#39;QC05-QC11&#39;]</span>
<span class="sd">    :type all: bool</span>
<span class="sd">    :param all: If true all possible combinations will be calculated</span>
<span class="sd">    :type old_style: bool</span>
<span class="sd">    :param old_style: If true, the suffic is generated using the `fs`</span>
<span class="sd">        ( &quot;_&lt;fs&gt;Hz&quot;) instead of being passed as a parameter)</span>
<span class="sd">    :type parallel: bool</span>
<span class="sd">    :param parallel: if true it tries to use as much cores as are available to</span>
<span class="sd">        do the computation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;`save_dir` doesn&#39;t exist ..... creating&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">old_style</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">Hz&quot;</span> <span class="o">%</span> <span class="n">fs</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
        <span class="n">base_patterns</span> <span class="o">=</span> <span class="n">find_comb</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">is_mat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_patterns</span> <span class="o">=</span> <span class="n">list_of_combinations</span>

    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_VChangeEstimateMultiRef</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                                                        <span class="n">save_dir</span><span class="p">,</span> \
                                                        <span class="n">center_win_len</span><span class="p">,</span> \
                                                        <span class="n">fmin</span><span class="p">,</span> \
                                                        <span class="n">fmax</span><span class="p">,</span> \
                                                        <span class="n">order</span><span class="p">,</span> \
                                                        <span class="n">fs</span><span class="p">,</span> \
                                                        <span class="n">smooth_win</span><span class="p">,</span> \
                                                        <span class="n">tw_start</span><span class="p">,</span> \
                                                        <span class="n">tw_len</span><span class="p">,</span> \
                                                        <span class="n">st_range</span><span class="p">,</span> \
                                                        <span class="n">st_steps</span><span class="p">,</span> \
                                                        <span class="n">suffix</span><span class="p">,</span> \
                                                        <span class="n">multi_ref_freq</span><span class="p">,</span> \
                                                        <span class="n">use_breakpoint</span><span class="p">,</span> \
                                                        <span class="n">breakpoint</span><span class="p">),</span> \
                               <span class="n">base_patterns</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">successfull</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">_VChangeEstimateMultiRef</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                                                   <span class="n">save_dir</span><span class="p">,</span> \
                                                   <span class="n">center_win_len</span><span class="p">,</span> \
                                                   <span class="n">fmin</span><span class="p">,</span> \
                                                   <span class="n">fmax</span><span class="p">,</span> \
                                                   <span class="n">order</span><span class="p">,</span> \
                                                   <span class="n">fs</span><span class="p">,</span> \
                                                   <span class="n">smooth_win</span><span class="p">,</span> \
                                                   <span class="n">tw_start</span><span class="p">,</span> \
                                                   <span class="n">tw_len</span><span class="p">,</span> \
                                                   <span class="n">st_range</span><span class="p">,</span> \
                                                   <span class="n">st_steps</span><span class="p">,</span> \
                                                   <span class="n">suffix</span><span class="p">,</span> \
                                                   <span class="n">multi_ref_freq</span><span class="p">,</span> \
                                                   <span class="n">use_breakpoint</span><span class="p">,</span> \
                                                   <span class="n">breakpoint</span><span class="p">),</span> \
                          <span class="n">base_patterns</span><span class="p">)</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;success_patterns.npy&#39;</span><span class="p">),</span> \
            <span class="n">successfull</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_vchange_estimate_multi_ref_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="c"># corr_dir = Directory()</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">smooth_win</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">center_win_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">tw_start</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">tw_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">st_range</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">st_steps</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">list_of_combinations</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">)</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">multi_ref_freq</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">use_breakpoint</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">breakpoint</span> <span class="o">=</span> <span class="n">Date</span><span class="p">()</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">old_style</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Tabbed</span><span class="p">(</span><span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_dir&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                                        <span class="c"># Item(&#39;corr_dir&#39;),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;old_style&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;suffix&#39;</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="s">&#39;filename suffix&#39;</span><span class="p">,</span>
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;not old_style&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;parallel&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Directories&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmax&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmin&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;smooth_win&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Processing&#39;</span><span class="p">),</span>
                                 <span class="n">Tabbed</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_start&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_len&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;center_win_len&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Time lag&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_range&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_steps&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Stretch&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;list_of_combinations&#39;</span><span class="p">,</span> \
                                             <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;all==False&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;combinations&#39;</span><span class="p">)),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;multi_ref_freq&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;use_breakpoint&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;breakpoint&#39;</span><span class="p">,</span>
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;use_breakpoint&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Multi-ref&#39;</span><span class="p">))</span>
    
<span class="c">#----------------------------------------------------------------------------#</span>


<div class="viewcode-block" id="create_plots_macro"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.create_plots_macro.html#miic.core.macro.create_plots_macro">[docs]</a><span class="k">def</span> <span class="nf">create_plots_macro</span><span class="p">(</span><span class="n">panel_load_dir</span><span class="p">,</span>
                       <span class="n">save_dir</span><span class="p">,</span>
                       <span class="n">list_of_combinations</span><span class="p">,</span>
                       <span class="n">start_day</span><span class="p">,</span>
                       <span class="n">stop_day</span><span class="p">,</span>
                       <span class="nb">all</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                       <span class="n">marker_day</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Velocity change and related correlation curve images creation.</span>

<span class="sd">    This is a basic tool to create figures for the velocity change and the</span>
<span class="sd">    related correlation curve. It is general enough but in case of need must</span>
<span class="sd">    be modified by hand.</span>

<span class="sd">    :type panel_load_dir: string</span>
<span class="sd">    :param panel_load_dir: Where the :class:`pandas.Panel&#39; objects are located</span>
<span class="sd">        (those one created with the function `from_single_pattern_to_panel`)</span>
<span class="sd">    :type save_dir: string</span>
<span class="sd">    :param save_dir: Directory where to save the resulting images</span>
<span class="sd">    :type list_of_combinations: list of str</span>
<span class="sd">    :param list_of_combinations: The list of combinations that we want to plot</span>
<span class="sd">        (e.g. [&#39;QC01-QC02&#39;,&#39;QC05-QC11&#39;]</span>
<span class="sd">    :type all: bool</span>
<span class="sd">    :param all: If true all possible combinations are used</span>
<span class="sd">    :type start_day: :class:`~datetime.Date`</span>
<span class="sd">    :param start_day: Starting day</span>
<span class="sd">    :type stop_day: :class:`~datetime.Date`</span>
<span class="sd">    :param stop_day: Stopping day</span>
<span class="sd">    :type marker_day: :class:`~datetime.Date`</span>
<span class="sd">    :param marker_day: If passed, a vertical red line will be plotted</span>
<span class="sd">        at this date.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;`save_dir` doesn&#39;t exist ..... creating&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="c"># Load the data</span>
    <span class="n">dcs_dict</span> <span class="o">=</span> <span class="n">load_pickled_Series_DataFrame_Panel</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">panel_load_dir</span><span class="p">,</span> <span class="s">&#39;dcs_dict.pickle&#39;</span><span class="p">))</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="n">dcs_dict</span><span class="p">[</span><span class="s">&#39;dvP&#39;</span><span class="p">]</span>
    <span class="n">qq</span> <span class="o">=</span> <span class="n">dcs_dict</span><span class="p">[</span><span class="s">&#39;corrP&#39;</span><span class="p">]</span>

    <span class="c"># pp = load(os.path.join(panel_load_dir, &#39;dv.pickle&#39;))</span>
    <span class="c"># qq = load(os.path.join(panel_load_dir, &#39;corr.pickle&#39;))</span>

    <span class="c"># Create the plots</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">labv</span><span class="p">,</span> <span class="n">labc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">qq</span><span class="p">):</span>

        <span class="n">dfv</span> <span class="o">=</span> <span class="n">pp</span><span class="p">[</span><span class="n">labv</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">start_day</span><span class="p">:</span><span class="n">stop_day</span><span class="p">]</span>
        <span class="n">dfc</span> <span class="o">=</span> <span class="n">qq</span><span class="p">[</span><span class="n">labc</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">start_day</span><span class="p">:</span><span class="n">stop_day</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="c"># Summit</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">dfv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfv</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">list_of_combinations</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># plt.ylim([-0.01, 0.01])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;dv/v&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Velocity change&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">marker_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">marker_day</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;dv_&#39;</span> <span class="o">+</span> <span class="n">labv</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">dfv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfv</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">list_of_combinations</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># plt.ylim([-0.01, 0.01])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;dv/v&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Velocity change&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">marker_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">marker_day</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;dv_&#39;</span> <span class="o">+</span> <span class="n">labv</span> <span class="o">+</span> <span class="s">&#39;_mean&#39;</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">dfc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfc</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">list_of_combinations</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Corr.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cross-Correlation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">marker_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">marker_day</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;corr_&#39;</span> <span class="o">+</span> <span class="n">labc</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="n">dfc</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfc</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="n">list_of_combinations</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Corr.&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cross-Correlation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">marker_day</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">marker_day</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;corr_&#39;</span> <span class="o">+</span> <span class="n">labc</span> <span class="o">+</span> <span class="s">&#39;_mean&#39;</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">))</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_create_plots_macro_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">panel_load_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">list_of_combinations</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">)</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">marker_day</span> <span class="o">=</span> <span class="bp">None</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;panel_load_dir&#39;</span><span class="p">),</span>
                          <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                          <span class="n">Item</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
                          <span class="n">Item</span><span class="p">(</span><span class="s">&#39;list_of_combinations&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                               <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;all==False&#39;</span><span class="p">))</span>
    
        <span class="k">def</span> <span class="nf">_all_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_of_combinations</span> <span class="o">=</span> <span class="p">[]</span>
    
    
<div class="viewcode-block" id="one_step_vchange_estimate_and_plot"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.one_step_vchange_estimate_and_plot.html#miic.core.macro.one_step_vchange_estimate_and_plot">[docs]</a><span class="k">def</span> <span class="nf">one_step_vchange_estimate_and_plot</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                     <span class="n">suffix</span><span class="p">,</span> \
                     <span class="n">save_dir</span><span class="p">,</span> \
                     <span class="c"># corr_dir, \</span>
                     <span class="n">center_win_len</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> \
                     <span class="n">fmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> \
                     <span class="n">fmin</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> \
                     <span class="n">order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> \
                     <span class="n">fs</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> \
                     <span class="n">smooth_win</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> \
                     <span class="n">tw_start_list</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> \
                     <span class="n">tw_len</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> \
                     <span class="n">st_range</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> \
                     <span class="n">st_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> \
                     <span class="n">list_of_combinations</span><span class="o">=</span><span class="p">[],</span> \
                     <span class="n">start_day</span><span class="o">=</span><span class="s">&#39;03/04/2010&#39;</span><span class="p">,</span> \
                     <span class="n">stop_day</span><span class="o">=</span><span class="s">&#39;03/04/2011&#39;</span><span class="p">,</span> \
                     <span class="nb">all</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
                     <span class="n">marker_day</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> \
                     <span class="n">old_style</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; One step function to do the velocity change estimation and plot</span>

<span class="sd">    This function wants to group together everything is necessary to move</span>
<span class="sd">    from the single auto-cross correlation functions to the velocity change</span>
<span class="sd">    estimation and plot in one step.</span>
<span class="sd">    It collates together the three ``macro`` functions ``vchange_estimate``,</span>
<span class="sd">    ``from_single_pattern_to_panel`` and ``create_plots_macro`` plus the</span>
<span class="sd">    creation of a standard directory structure to hold all the produced</span>
<span class="sd">    results in a consistent way plus a configuration file that stores all</span>
<span class="sd">    the parameters that have been adopted to produce them.</span>

<span class="sd">    :type base_dir: directory</span>
<span class="sd">    :param base_dir: Where the auto-cross correlation matrix are stored</span>
<span class="sd">    :type save_dir: directory</span>
<span class="sd">    :param save_dir: Where all results will be saved (see Notes for details)</span>
<span class="sd">    :type center_win_len: int</span>
<span class="sd">    :param center_win_len: How many samples will be taken from the central part</span>
<span class="sd">        of the corr func</span>
<span class="sd">    :type fmax: float</span>
<span class="sd">    :param fmax: Maximum freq for the bandpass filter</span>
<span class="sd">    :type fmin: float</span>
<span class="sd">    :param fmin: Minimum freq for the bandpass filter</span>
<span class="sd">    :type order: int</span>
<span class="sd">    :param order: Filter order (i.e. corners in obspy terminology)</span>
<span class="sd">    :type fs: float</span>
<span class="sd">    :param fs: Sampling frequency for the corr trace</span>
<span class="sd">    :type smooth_win: int</span>
<span class="sd">    :param smooth_win: Width of the smoothing window</span>
<span class="sd">    :type tw_start_list: list of int</span>
<span class="sd">    :param tw_start_list: List of time lag (in samples) that we want to adopt</span>
<span class="sd">        in the velocity change evaluation</span>
<span class="sd">    :type tw_len: list of int</span>
<span class="sd">    :param tw_len: Time window length in samples for each time lag</span>
<span class="sd">    :type st_range: float</span>
<span class="sd">    :param st_range: Stretching range (i.e. 0.01 -&gt; 1%)</span>
<span class="sd">    :type st_steps: int</span>
<span class="sd">    :param st_steps: How many stretching steps in the specified range</span>
<span class="sd">    :type list_of_combinations: list of string</span>
<span class="sd">    :param list_of_combinations: The list of combinations that we want to plot</span>
<span class="sd">        (e.g. [&#39;QC01-QC02&#39;,&#39;QC05-QC11&#39;]</span>
<span class="sd">    :type all: bool</span>
<span class="sd">    :param all: If true all available combinations are ploted</span>
<span class="sd">    :type start_day: `~datetime.date` object</span>
<span class="sd">    :param start_day: Starting day</span>
<span class="sd">    :type stop_day: `~datetime.date` object</span>
<span class="sd">    :param stop_day: Stoplting day</span>
<span class="sd">    :type marker_day: `~datetime.date` object</span>
<span class="sd">    :param marker_day: If passed a vertical red line will be plotted</span>
<span class="sd">        at this date.</span>
<span class="sd">    :type suffix: string</span>
<span class="sd">    :param suffix: Optional suffix for the filename to look for (it must be the</span>
<span class="sd">        same as used with the :class:`~miic.core.macro.vchange_estimate`</span>
<span class="sd">        function through with the corr ad dv/v curves were created)</span>
<span class="sd">    :type old_style: bool</span>
<span class="sd">    :param old_style: If true, the suffic is generated using the `fs`</span>
<span class="sd">        ( &quot;_&lt;fs&gt;Hz&quot;) instead of being passed as a parameter)</span>

<span class="sd">    .. rubric:: Notes</span>

<span class="sd">    The directories structure that will be created under ``save_dir`` has this</span>
<span class="sd">    layout:</span>

<span class="sd">    ``save_dir``</span>
<span class="sd">        |------&gt; panels</span>
<span class="sd">        |------&gt; img</span>
<span class="sd">        |``vchange_files``</span>

<span class="sd">    ``panels`` stores the :class:`~pandas.Panel` objects</span>
<span class="sd">    ``img`` stores all produced images</span>
<span class="sd">    In ``save_dir`` is also stored a configuration.txt file that contains all</span>
<span class="sd">    the parameters in the currunt setup in the for of key-&gt;value pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONFIG_FILENAME</span> <span class="o">=</span> <span class="s">&#39;configuration.txt&#39;</span>

    <span class="c"># Do some error checking</span>
    <span class="k">if</span> <span class="n">save_dir</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Empty save path.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Save path </span><span class="si">%s</span><span class="s"> doesn&#39;t point to a directory&quot;</span> <span class="o">%</span> <span class="n">save_dir</span><span class="p">)</span>

    <span class="c"># Create the directory structure</span>
    <span class="n">panels_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;panels&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">panels_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">panels_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Warning: `panels` directory already exist&quot;</span><span class="p">)</span>

    <span class="n">img_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s">&#39;img&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">img_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Warning: `img` directory already exist&quot;</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dataset</span><span class="p">[</span><span class="s">&#39;corr_matrix_folder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>
    <span class="c"># dataset[&#39;correlation_functions_folder&#39;] = corr_dir</span>

    <span class="c"># Save the parameters values</span>
    <span class="n">vchange_filtering</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vchange_filtering</span><span class="p">[</span><span class="s">&#39;fmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmax</span>
    <span class="n">vchange_filtering</span><span class="p">[</span><span class="s">&#39;fmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fmin</span>
    <span class="n">vchange_filtering</span><span class="p">[</span><span class="s">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
    <span class="n">vchange_filtering</span><span class="p">[</span><span class="s">&#39;fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span>
    <span class="n">vchange_filtering</span><span class="p">[</span><span class="s">&#39;smooth_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_win</span>

    <span class="n">vchange_stretch</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vchange_stretch</span><span class="p">[</span><span class="s">&#39;time_windows_start_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_start_list</span>
    <span class="n">vchange_stretch</span><span class="p">[</span><span class="s">&#39;time_windows_len_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tw_len</span>
    <span class="n">vchange_stretch</span><span class="p">[</span><span class="s">&#39;stretching_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_range</span>
    <span class="n">vchange_stretch</span><span class="p">[</span><span class="s">&#39;stretching_steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st_steps</span>

    <span class="n">vchange_combinations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vchange_combinations</span><span class="p">[</span><span class="s">&#39;all_combinations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">all</span>
    <span class="n">vchange_combinations</span><span class="p">[</span><span class="s">&#39;list_of_combinations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_of_combinations</span>

    <span class="n">vchange_plot</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">vchange_plot</span><span class="p">[</span><span class="s">&#39;start_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_day</span>
    <span class="n">vchange_plot</span><span class="p">[</span><span class="s">&#39;stop_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop_day</span>
    <span class="n">vchange_plot</span><span class="p">[</span><span class="s">&#39;marker_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marker_day</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigObj</span><span class="p">()</span>

    <span class="n">config</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">CONFIG_FILENAME</span><span class="p">)</span>
    <span class="n">config</span><span class="p">[</span><span class="s">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span>
    <span class="n">config</span><span class="p">[</span><span class="s">&#39;combinations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vchange_combinations</span>
    <span class="n">config</span><span class="p">[</span><span class="s">&#39;filtering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vchange_filtering</span>
    <span class="n">config</span><span class="p">[</span><span class="s">&#39;stretching&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vchange_stretch</span>
    <span class="n">config</span><span class="p">[</span><span class="s">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vchange_plot</span>

    <span class="c"># Write the configuration to file</span>
    <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="n">vchange_estimate</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> \
                     <span class="n">suffix</span><span class="p">,</span> \
                     <span class="n">save_dir</span><span class="p">,</span> \
                     <span class="c"># corr_dir, \</span>
                     <span class="n">center_win_len</span><span class="p">,</span> \
                     <span class="n">fmax</span><span class="p">,</span> \
                     <span class="n">fmin</span><span class="p">,</span> \
                     <span class="n">order</span><span class="p">,</span> \
                     <span class="n">fs</span><span class="p">,</span> \
                     <span class="n">smooth_win</span><span class="p">,</span> \
                     <span class="n">tw_start_list</span><span class="p">,</span> \
                     <span class="n">tw_len</span><span class="p">,</span> \
                     <span class="n">st_range</span><span class="p">,</span> \
                     <span class="n">st_steps</span><span class="p">,</span> \
                     <span class="n">list_of_combinations</span><span class="p">,</span> \
                     <span class="nb">all</span><span class="p">,</span> \
                     <span class="n">old_style</span><span class="p">)</span>

    <span class="n">from_single_pattern_to_panel</span><span class="p">(</span><span class="n">load_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> \
                                 <span class="n">save_dir</span><span class="o">=</span><span class="n">panels_dir</span><span class="p">,</span> \
                                 <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="n">old_style</span><span class="o">=</span><span class="n">old_style</span><span class="p">)</span>

    <span class="n">create_plots_macro</span><span class="p">(</span><span class="n">panels_dir</span><span class="p">,</span> \
                       <span class="n">img_dir</span><span class="p">,</span> \
                       <span class="n">list_of_combinations</span><span class="p">,</span> \
                       <span class="n">start_day</span><span class="p">,</span> <span class="n">stop_day</span><span class="p">,</span> \
                       <span class="nb">all</span><span class="o">=</span><span class="nb">all</span><span class="p">,</span> \
                       <span class="n">marker_day</span><span class="o">=</span><span class="n">marker_day</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_one_step_vchange_estimate_and_plot_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="c"># corr_dir = Directory()</span>
        <span class="n">old_style</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">Str</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">center_win_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">fmax</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
        <span class="n">smooth_win</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">tw_start_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>
        <span class="n">tw_len</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
        <span class="n">st_range</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="n">st_steps</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">list_of_combinations</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Str</span><span class="p">)</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="n">Date</span><span class="p">()</span>
        <span class="n">stop_day</span> <span class="o">=</span> <span class="n">Date</span><span class="p">()</span>
        <span class="n">marker_day</span> <span class="o">=</span> <span class="n">Date</span><span class="p">()</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Tabbed</span><span class="p">(</span><span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_dir&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                                        <span class="c"># Item(&#39;corr_dir&#39;),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;old_style&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;suffix&#39;</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="s">&#39;filename suffix&#39;</span><span class="p">,</span>
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;not old_style&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Directories&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;list_of_combinations&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">enabled_when</span><span class="o">=</span><span class="s">&#39;all==False&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Combinations&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmax&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fmin&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;fs&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;smooth_win&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Processing&#39;</span><span class="p">),</span>
                                 <span class="n">Tabbed</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_start_list&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;tw_len&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;center_win_len&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Time lag&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_range&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;st_steps&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Stretch&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;start_day&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;stop_day&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;marker_day&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Plot&#39;</span><span class="p">)))</span>
    
        <span class="k">def</span> <span class="nf">_all_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">old</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_of_combinations</span> <span class="o">=</span> <span class="p">[]</span>
    
    
<div class="viewcode-block" id="plot_corr_matrix"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.plot_corr_matrix.html#miic.core.macro.plot_corr_matrix">[docs]</a><span class="k">def</span> <span class="nf">plot_corr_matrix</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span> \
                     <span class="n">save_dir</span><span class="o">=</span><span class="s">&#39;./img&#39;</span><span class="p">,</span> \
                     <span class="n">center_win_len</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> \
                     <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                     <span class="n">plot_selected_curves</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> \
                     <span class="n">selected_curves_idx_list</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Plot all correlation matrixes stored in a folder as .mat file</span>

<span class="sd">    This is a basic function to plot the correlation matrixes stored in a</span>
<span class="sd">    folder as .mat files.</span>
<span class="sd">    It loads each matrix, check if time information are available in the same</span>
<span class="sd">    file and then creates a ``contourf`` plot with 20 levels.</span>
<span class="sd">    It also add simple lables to each axis and a generic title &quot;Correlation</span>
<span class="sd">    Matrix&quot;.</span>
<span class="sd">    It is also possible to generate, at the same time, plots of a list of</span>
<span class="sd">    interesting correlation functions just setting</span>
<span class="sd">    ``plot_selected_curves==True`` and passing the list of indexes in the</span>
<span class="sd">    parameter ``selected_curves_idx_list``.</span>

<span class="sd">    :type base_dir: directory</span>
<span class="sd">    :param base_dir: Where the auto-cross correlation matrix are stored</span>
<span class="sd">    :type save_dir: directory</span>
<span class="sd">    :param save_dir: Directory where to save the resulting images</span>
<span class="sd">    :type center_win_len: int</span>
<span class="sd">    :param center_win_len: How many samples will be taken from the central part</span>
<span class="sd">        of the correlation function</span>
<span class="sd">    :type axis: int</span>
<span class="sd">    :param axis: On which axis apltly the selection</span>
<span class="sd">        (axis==1 cols, axis==1 rows)</span>
<span class="sd">    :type plot_selected_curves: bool</span>
<span class="sd">    :param plot_selected_curves: If it is requested to plot single correlation</span>
<span class="sd">        functions</span>
<span class="sd">    :type selected_curves_idx_list: list of int</span>
<span class="sd">    :param selected_curves_idx_list: The list of index (in the selected axis)</span>
<span class="sd">        of the curves that will be ploted</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;*.mat&#39;</span>
    <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">f_pattern</span><span class="p">,</span> \
                           <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># create the location for saving the figures</span>
    <span class="k">if</span> <span class="n">files_list1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files_list1</span><span class="p">:</span>
        <span class="c"># load the correlation matrix</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">mat_to_ndarray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">flatten</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># create the name of the file to save</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span><span class="p">)</span>
        <span class="n">base_new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">spiece</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spiece</span><span class="p">)</span> <span class="ow">in</span>\
                                             <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>\
                                             <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">figure_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">base_new_name</span><span class="p">)</span>

        <span class="c"># call the function to create and save the figure</span>
        <span class="n">plot_single_corr_matrix</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">center_win_len</span><span class="o">=</span><span class="n">center_win_len</span><span class="p">,</span> \
                                <span class="n">filename</span><span class="o">=</span><span class="n">figure_file_name</span><span class="p">)</span>

        <span class="c"># go ahead with plotting selected correlation functions</span>
        <span class="k">if</span> <span class="n">plot_selected_curves</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">aa</span><span class="p">[</span><span class="s">&#39;corr_data&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">aa</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">convert_time</span><span class="p">(</span><span class="n">aa</span><span class="p">[</span><span class="s">&#39;time&#39;</span><span class="p">])</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">nd_mat_center_part</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">center_win_len</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">tlag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> \
                         <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">selected_curves_idx_list</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;One or more indexs out of range. Skip&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">selected_curves_idx_list</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;One or more indexs out of range. Skip&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">selected_curves_idx_list</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tlag</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Corr. value&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Time lag&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tlag</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;Corr. value&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Time lag&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">aa</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;Day &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()])</span>
                    <span class="n">sidx</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s">&#39;Day &#39;</span> <span class="o">+</span> <span class="n">idx</span><span class="p">])</span>
                    <span class="n">sidx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Correlation Function&#39;</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">base_new_name</span> <span class="o">+</span> \
                                         <span class="s">&#39;_corrFunctDay_&#39;</span> <span class="o">+</span> <span class="n">sidx</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">))</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_plot_corr_matrix_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
    
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">center_win_len</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">Enum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">plot_selected_curves</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">selected_curves_idx_list</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="n">Int</span><span class="p">)</span>
    
        <span class="n">trait_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Tabbed</span><span class="p">(</span><span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;base_dir&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Dirs&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;center_win_len&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;axis&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Selection&#39;</span><span class="p">),</span>
                                 <span class="n">VGroup</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;plot_selected_curves&#39;</span><span class="p">),</span>
                                        <span class="n">Item</span><span class="p">(</span><span class="s">&#39;selected_curves_idx_list&#39;</span><span class="p">,</span> \
                                             <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                                             <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> \
                                             <span class="n">label</span><span class="o">=</span><span class="s">&#39;Selected idxs&#39;</span><span class="p">),</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Single curves&#39;</span><span class="p">)))</span>
    

<div class="viewcode-block" id="plot_dvs_macro"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.plot_dvs_macro.html#miic.core.macro.plot_dvs_macro">[docs]</a><span class="k">def</span> <span class="nf">plot_dvs_macro</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="s">&#39;./img&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot all correlation matrixes stored in a folder as .mat file</span>

<span class="sd">    This is a basic function to plot the velocity change dv dictionaries</span>
<span class="sd">    stored in a folder as .mat files.</span>
<span class="sd">    It loads each dictionary, check if their content is in agreement with the</span>
<span class="sd">    presumed structure and the plot it.</span>

<span class="sd">    :type base_dir: directory</span>
<span class="sd">    :param base_dir: Where the auto-cross correlation matrix are stored</span>
<span class="sd">    :type save_dir: directory</span>
<span class="sd">    :param save_dir: Directory where to save the resulting images</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f_pattern</span> <span class="o">=</span> <span class="s">&#39;*.mat&#39;</span>
    <span class="n">files_list1</span> <span class="o">=</span> <span class="n">dir_read</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">f_pattern</span><span class="p">,</span> \
                           <span class="n">sort_flag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># create the location for saving the figures</span>
    <span class="k">if</span> <span class="n">files_list1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files_list1</span><span class="p">:</span>
        <span class="c"># load the correlation matrix</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">mat_to_ndarray</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="n">check_staus</span> <span class="o">=</span> <span class="n">dv_check</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_staus</span><span class="p">[</span><span class="s">&#39;is_incomplete&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c"># create the name of the file to save</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span><span class="p">)</span>
        <span class="n">base_new_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extsep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">spiece</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spiece</span><span class="p">)</span> <span class="ow">in</span>\
                                             <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>\
                                             <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">figure_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">base_new_name</span><span class="p">)</span>

        <span class="c"># call the function to create and save the figure</span>
        <span class="n">plot_dv</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">figure_file_name</span><span class="o">=</span><span class="n">figure_file_name</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">_SpeedUpPlot</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">xpt</span><span class="p">,</span> <span class="n">ypt</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> \
                 <span class="n">the_levels</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpt</span> <span class="o">=</span> <span class="n">xpt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypt</span> <span class="o">=</span> <span class="n">ypt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span> <span class="o">=</span> <span class="n">xgrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ygrid</span> <span class="o">=</span> <span class="n">ygrid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_levels</span> <span class="o">=</span> <span class="n">the_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">m</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day</span><span class="p">):</span>
        <span class="n">strday</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">day</span><span class="p">]</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">zpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">day</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">z_s</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypt</span><span class="p">,</span> <span class="n">zpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span><span class="p">,</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">ygrid</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s">&#39;nn&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xpt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="s">&#39;w--&#39;</span><span class="p">,</span> \
                    <span class="n">marker</span><span class="o">=</span><span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ygrid</span><span class="p">,</span> <span class="n">z_s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">the_levels</span><span class="p">,</span> \
                        <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">strday</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s">&#39;figure fraction&#39;</span><span class="p">)</span>

        <span class="c"># plt.axis(&#39;equal&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Velocity Change&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">jet</span><span class="p">()</span>
        <span class="c"># plt.gca().set_xlim(55.65, 55.782)</span>
        <span class="c"># plt.setp(plt.gca(), &#39;yticklabels&#39;, [])</span>
        <span class="c"># plt.setp(plt.gca(), &#39;xticklabels&#39;, [])</span>
        <span class="c"># plt.gcf().canvas.draw()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%2.3e</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">strday</span> <span class="o">+</span> <span class="s">&#39;_dv_tomo.png&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>


<div class="viewcode-block" id="real_vchanges_tomograpy"><a class="viewcode-back" href="../../../modules/autogen/miic.core.macro.real_vchanges_tomograpy.html#miic.core.macro.real_vchanges_tomograpy">[docs]</a><span class="k">def</span> <span class="nf">real_vchanges_tomograpy</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">lat_lon_alt_filename</span><span class="p">,</span> \
                            <span class="n">real_velocity_change_filename</span><span class="p">,</span> <span class="n">inter_points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple tomography obtained using also matplotlib BaseMap (experimental)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
    <span class="kn">import</span> <span class="nn">re</span>

    <span class="n">df_geo_data</span> <span class="o">=</span> <span class="n">lat_lon_ele_load</span><span class="p">(</span><span class="n">lat_lon_alt_filename</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">load_pickled_Series_DataFrame_Panel</span><span class="p">(</span><span class="n">real_velocity_change_filename</span><span class="p">)</span>
    <span class="n">R</span><span class="p">[</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">R</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">R</span>  <span class="c"># To conform to the conventional colors adopted for seismic</span>
                <span class="c"># tomography</span>

    <span class="c"># Select just the geo data related to the statons that are included in</span>
    <span class="c"># the R DataFrame</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">df_geo_data</span> <span class="o">=</span> <span class="n">df_geo_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> \
                                     <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">stations_in_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> \
                         <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df_geo_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

    <span class="c"># Rearrange R to the same order as the geo informations</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">stations_in_order</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">index</span>

    <span class="n">R_min</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">R_max</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c"># Plot parameters</span>

    <span class="k">if</span> <span class="n">R_max</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">the_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">R_min</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">R_max</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">R_max</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">the_levels1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">R_max</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">the_levels2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">R_min</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>

        <span class="n">the_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">the_levels2</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">the_levels1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">R_max</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">R_min</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">the_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">R_max</span><span class="p">)),</span> \
                                 <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">R_min</span><span class="p">)),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">the_levels</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">the_levels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c"># the_levels = np.log10(np.logspace(R_min, R_max,100))</span>
    <span class="c">#    the_levels=np.log10(np.logspace(R_min, R_max,100))</span>
    <span class="c">#    the_colors = np.linspace(.21, 1.0, 20)</span>
    <span class="c">#    the_colors = str(the_colors).split()[1:-1]</span>

    <span class="c"># Create the Basemap object</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="mf">55.6</span><span class="p">,</span> <span class="n">llcrnrlat</span><span class="o">=</span> <span class="o">-</span><span class="mf">21.4</span><span class="p">,</span> <span class="n">urcrnrlon</span><span class="o">=</span><span class="mf">55.85</span><span class="p">,</span> \
                <span class="n">urcrnrlat</span><span class="o">=</span> <span class="o">-</span><span class="mf">21.18</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s">&#39;lcc&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s">&#39;f&#39;</span><span class="p">,</span> \
                <span class="n">lat_1</span><span class="o">=</span> <span class="o">-</span><span class="mf">21.</span><span class="p">,</span> <span class="n">lat_2</span><span class="o">=</span> <span class="o">-</span><span class="mf">21.5</span><span class="p">,</span> <span class="n">lat_0</span><span class="o">=</span> <span class="o">-</span><span class="mf">21.25</span><span class="p">,</span> <span class="n">lon_0</span><span class="o">=</span><span class="mf">55.7</span><span class="p">)</span>

    <span class="n">parallels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">22.</span><span class="p">,</span> <span class="o">-</span><span class="mf">21.</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">meridians</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">55.45</span><span class="p">,</span> <span class="mf">55.9</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">xpt</span><span class="p">,</span> <span class="n">ypt</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">df_geo_data</span><span class="p">[</span><span class="s">&#39;latitude&#39;</span><span class="p">],</span> <span class="n">df_geo_data</span><span class="p">[</span><span class="s">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">delaunay</span><span class="o">.</span><span class="n">delaunay</span><span class="p">(</span><span class="n">xpt</span><span class="p">,</span> <span class="n">ypt</span><span class="p">)</span>

    <span class="n">xg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">xpt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">xpt</span><span class="p">),</span> <span class="n">inter_points</span><span class="p">)</span>
    <span class="n">yg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ypt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ypt</span><span class="p">),</span> <span class="n">inter_points</span><span class="p">)</span>
    <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">time</span><span class="p">:</span>

        <span class="n">zpt</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">zpt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>

            <span class="n">strday</span> <span class="o">=</span> <span class="n">day</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

            <span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">drawparallels</span><span class="p">(</span><span class="n">parallels</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">m</span><span class="o">.</span><span class="n">drawmeridians</span><span class="p">(</span><span class="n">meridians</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">z_s</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">mlab</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">xpt</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">ypt</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">zpt</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                                    <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s">&#39;nn&#39;</span><span class="p">)</span>

            <span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xpt</span><span class="p">[</span><span class="n">edges</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">ypt</span><span class="p">[</span><span class="n">edges</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;0.8&#39;</span><span class="p">,</span>
                   <span class="n">marker</span><span class="o">=</span><span class="s">&#39;v&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">markeredgecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="n">xx</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">z_s</span><span class="p">,</span> <span class="n">the_levels</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">strday</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s">&#39;figure fraction&#39;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="s">&#39;xx-large&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s">&#39;bold&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Velocity Change&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">jet</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%5.4f</span><span class="s">&#39;</span><span class="p">,</span>
                         <span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R_min</span><span class="p">,</span> <span class="n">R_max</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                         <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">strday</span> <span class="o">+</span> <span class="s">&#39;_dv_tomo.png&#39;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">BC_UI</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">_real_vchanges_tomograpy_view</span><span class="p">(</span><span class="n">HasTraits</span><span class="p">):</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">()</span>
        <span class="n">lat_lon_alt_filename</span> <span class="o">=</span> <span class="n">File</span><span class="p">()</span>
        <span class="n">real_velocity_change_filename</span> <span class="o">=</span> <span class="n">File</span><span class="p">()</span>
        <span class="n">inter_points</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="mi">1500</span><span class="p">)</span>
    
        <span class="n">traits_view</span> <span class="o">=</span> <span class="n">View</span><span class="p">(</span><span class="n">Item</span><span class="p">(</span><span class="s">&#39;save_dir&#39;</span><span class="p">),</span>
                           <span class="n">Item</span><span class="p">(</span><span class="s">&#39;lat_lon_alt_filename&#39;</span><span class="p">),</span>
                           <span class="n">Item</span><span class="p">(</span><span class="s">&#39;real_velocity_change_filename&#39;</span><span class="p">),</span>
                           <span class="n">Item</span><span class="p">(</span><span class="s">&#39;inter_points&#39;</span><span class="p">))</span>
        

<span class="c"># EOF</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">MIIC 1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012, Eraldo Pomponi.
      Last updated on 2017-11-15T10:15:30.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>